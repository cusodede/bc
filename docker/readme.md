# Докеризация проекта

Нижеописанные манипуляции позволят развернуть рабочее окружение в докер-контейнере и начать работу над проектом сразу же.<br />
Вам, естественно, потребуется docker. ОС - не важна (если docker там работает), но между win/mac/linux будут некоторые различия в настройке, которые описываются отдельно.

# Что тут где?

`docker-compose.yml` - скрипт сборки контейнера.<br />
`/docker/env/*` - конфиг переменных окружения в контейнере. Группируются по сервисам (или по другому принципу).<br />
`.example.env` - конфиг переменных окружения в контейнере. Часть из них необходима для конфигурации docker-compose, а часть - для проброса внутрь контейнеров (например, там в них содержатся учётные данные для подключения к создаваемой БД).<br />
`/docker/Dockerfile` - скрипт исполнения в слое контейнера. Там же лежат другие файлики с префиксом Dockerfile* - это скрипты для production ci/cd.<br />
`/docker/configMap/*`, `/docker/nginx/*`, `/docker/php/php.ini` - это скрипты генерации конфигов/сами конфиги, с которым будут запускаться сервисы в контейнере.<br />
`/docker/configMap/*` - манифесты для деплоя в OKD.<br />
`/docker/databases` - сюда сложит файлы базы данных запущенный в контейнере сервис MySQL (надеюсь, что к моменту, когда ты это читаешь, то уже и PostgreSQL).<br />
`Makefile` - скрипт для GNU make, с алиасами команд запуска сборки и управления контейнером.<br />

Всё остальное - код, конфиги приложения, пакеты, etc, остаётся как есть.

## Пошаговые инструкции

1. На основе файла `.example.env` создаем файл `.env` (в той же папке). Проверяем `.env`, если надо - редактируем. Обрати внимание на параметр `XDEBUG_CONFIG`: по умолчанию он сконфигурирован для win/mac, но в комментарии есть вариант и для linux.
2. На основе файлов `*.example.env` создаем файлы `*.env` (в той же папке). Если надо, то пишем/меняем перемены окружения в `*.env` файлах.
3. На основе файла `php.example.ini` создаем файл `php.ini` (в той же папке). Если мы на Линукс, то надо будет его редактировать.
4. Запускаем `make build` либо `composer build` в зависимости от того, что у вас есть под рукой. Если нет ничего из этого - смотрим содержимое `Makefile`, видим, что `make build` === `docker-compose up -d --build`, и запускаем.
5. На этом этапе контейнеры должны собраться, а сервисы в них - заработать. Если этого не произошло <s>паникуем и просим помощи</s> пытаемся разобраться вкуривая логи. И если не получилось самому - тогда просим помощи.
6. Устанавливать зависимости проекта и выполнять миграции нужно внутри слоя `bc_php-8`. Это делается либо руками внутри контейнера (стандартно `composer install && composer migrations`), либо через `make` (`make composer`, `make migrate` либо общим скриптом `make setup`), ну или скриптом `composer setup`. Предполагается, что если вы это читаете, то у вас есть понимание, что делать.
7. Чтобы не ходить за выполнением каких-то команд внутрь контейнера (хотя так тоже можно), у нас есть `make exec` и `composer execute`.

## Важное-полезное

Для корректной работы Xdebug внутри Docker-контейнера создается общая сеть для бандла в docker-compose `192.168.221.0/28`. Это сделано для того, чтоб каждому члену команды не приходилось бы менять IP-адрес на свой в общем файле конфигурации бандла.<br />
Перед запуском сборки нужно убедиться в том, что в `php.ini` включены нужные настройки под ОС.<br />
Для систем MacOS или Windows, в параметре `xdebug.client_host` должно быть значение `host.docker.internal`. Для UNIX систем в этом параметре нужно установить адрес `192.168.221.1`.

## Алиасы для GNU make

### Сборка контейнеров
~~~
make build
~~~
### Вход в контейнер
~~~
make exec s=<название контейнера>
~~~
### Запуск скрипта для установки зависимостей и выполнения миграций
~~~
make setup
~~~
### Проверить запущенные контейнеры
~~~
docker ps
~~~
### Посмотреть установленные образы
~~~
docker images
~~~
### Посмотреть логи контейнера
~~~
docker logs <имя контейнера>
~~~

## Алиасы для composer

### Сборка контейнеров
~~~
composer build
~~~
### Запуск контейнеров
~~~
composer up
~~~
### Остановка контейнеров
~~~
composer stop
~~~
### Перезапуск контейнеров
~~~
composer restart
~~~
### Вход в контейнер
~~~
composer exec s=<название контейнера>
~~~
### Запуск скрипта для установки зависимостей и выполнения миграций
~~~
composer setup
~~~
