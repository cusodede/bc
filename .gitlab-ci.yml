stages:
  - build
  - back
  - migrate
  - deploy
build_base:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
   
  variables:
    dockerfile_path: docker/Dockerfile_base
  script:
    - cat ${CA_CERTIFICATE} >> /kaniko/ssl/certs/additional-ca-cert-bundle.crt
    - mkdir -p /kaniko/.docker
    - |-
       KANIKOPROXYBUILDARGS=""
       KANIKOCFG=${DOCKER_AUTH_CONFIG}
       if [ "x${http_proxy}" != "x" -o "x${https_proxy}" != "x" ]; then
         KANIKOCFG="${KANIKOCFG}, \"proxies\": { \"default\": { \"httpProxy\": \"${http_proxy}\", \"httpsProxy\": \"${https_proxy}\", \"noProxy\": \"${no_proxy}\"}}"
         KANIKOPROXYBUILDARGS="--build-arg http_proxy=${http_proxy} --build-arg https_proxy=${https_proxy} --build-arg no_proxy=${no_proxy}"
       fi
       KANIKOCFG="${KANIKOCFG} }"
       echo "${KANIKOCFG}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/$dockerfile_path $KANIKOPROXYBUILDARGS --destination ${CI_REGISTRY_IMAGE}_base:latest --build-arg COMPOSER_TOKEN=${COMPOSER_TOKEN}
  only:
    refs:
      - master
    changes:
      - docker/Dockerfile_base
  tags:
    - okd

build_back:
  stage: back
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
   
  variables:
    dockerfile_path: docker/Dockerfile_back
  script:
    - cat ${CA_CERTIFICATE} >> /kaniko/ssl/certs/additional-ca-cert-bundle.crt
    - mkdir -p /kaniko/.docker
    - |-
       KANIKOPROXYBUILDARGS=""
       KANIKOCFG=${DOCKER_AUTH_CONFIG}
       if [ "x${http_proxy}" != "x" -o "x${https_proxy}" != "x" ]; then
         KANIKOCFG="${KANIKOCFG}, \"proxies\": { \"default\": { \"httpProxy\": \"${http_proxy}\", \"httpsProxy\": \"${https_proxy}\", \"noProxy\": \"${no_proxy}\"}}"
         KANIKOPROXYBUILDARGS="--build-arg http_proxy=${http_proxy} --build-arg https_proxy=${https_proxy} --build-arg no_proxy=${no_proxy}"
       fi
       KANIKOCFG="${KANIKOCFG} }"
       echo "${KANIKOCFG}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/$dockerfile_path $KANIKOPROXYBUILDARGS --destination ${CI_REGISTRY_IMAGE}_back:${CI_COMMIT_BRANCH}
  only:
    - master
  when: manual
  tags:
    - okd



migrate_db:
  stage: migrate
  image:
    name: harbor.vimpelcom.ru/prpl/prpl_back:${CI_COMMIT_BRANCH}
    entrypoint: [""]
  script:
    - cd /var/www/ppl
    - chmod +x yii
    - ./yii migrate --interactive=0
  only:
    - master
  when: manual
  tags:
    - okd

deploy_to_okd:
  stage: deploy
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
   
  variables:
    dockerfile_path: docker/Dockerfile_deploy
  script:
    - cat ${CA_CERTIFICATE} >> /kaniko/ssl/certs/additional-ca-cert-bundle.crt
    - mkdir -p /kaniko/.docker
    - |-
       KANIKOPROXYBUILDARGS=""
       KANIKOCFG=${DOCKER_AUTH_CONFIG}
       if [ "x${http_proxy}" != "x" -o "x${https_proxy}" != "x" ]; then
         KANIKOCFG="${KANIKOCFG}, \"proxies\": { \"default\": { \"httpProxy\": \"${http_proxy}\", \"httpsProxy\": \"${https_proxy}\", \"noProxy\": \"${no_proxy}\"}}"
         KANIKOPROXYBUILDARGS="--build-arg http_proxy=${http_proxy} --build-arg https_proxy=${https_proxy} --build-arg no_proxy=${no_proxy}"
       fi
       KANIKOCFG="${KANIKOCFG} }"
       echo "${KANIKOCFG}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/$dockerfile_path $KANIKOPROXYBUILDARGS --destination ${CI_REGISTRY_IMAGE}_deploy:${CI_COMMIT_BRANCH} --build-arg CI_COMMIT_BRANCH=${CI_COMMIT_BRANCH}
  only:
    - master
  when: manual
  tags:
    - okd




apply_config_to_okd:
  stage: deploy
  image:
    name: openshift/origin-cli:v3.11.0
    entrypoint: [""]
  variables:
    KUBECONFIG: $CI_PROJECT_DIR/kube
    NO_PROXY: api.k01.vimpelcom.ru
  before_script:
    - oc login --server="$OPENSHIFT_K01_SERVER" --token="$OPENSHIFT_K01_GITLAB_TOKEN" --insecure-skip-tls-verify
  script:
    - oc apply -f docker/configMap/db.configmap.yaml
    - oc apply -f docker/configMap/nginx.configmap.yaml
    - oc apply -f docker/configMap/php8.configmap.yaml
    - oc apply -f docker/configMap/supervisor.configmap.yaml
    - oc apply -f docker/deployment.yaml
  only:
    refs:
      - master
    changes:
      - docker/configMap/*.yaml
      - docker/deployment.yaml
  tags:
    - okd
   
   
   